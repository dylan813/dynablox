<?xml version="1.0" encoding="UTF-8"?>

<launch>
  <!-- ========== Arguments ========== -->
  <!-- Dataset -->
  <arg name="use_doals" default="false" />  <!-- Which dataset to play -->
  <arg name="bag_file" default="/home/cerlab/Documents/data/pointosr/benchmark/mall_lawn/mall_lawn.bag" />  <!-- Full path to the bag file to play -->
  <arg name="player_rate" default="1" />  <!-- Real time rate of bag being played -->
  
  <!-- Drift Simulation -->
  <arg name="drift_simulation_rollout" default="" />  <!-- Leave empty to ignore drift or specify a rollout that matches the dataset bein played --> 
  
  <!-- Evaluation -->
  <arg name="evaluate" default="false" />  <!-- Whether to save evaluation data -->  
  <arg name="eval_output_path" default="/home/cerlab/Documents/data/dynablox_output" />  <!-- Where to save evaluation data  -->
  <arg name="ground_truth_file" default="/home/cerlab/Documents/data/DOALS/hauptgebaeude/sequence_1/indices.csv" />  <!-- GT data file. Currently supports DOALS -->
  
  <!-- Motion Detector -->
  <arg name="config_file" default="motion_detector/default.yaml" />  <!-- Configuration of Dynablox -->
  <arg name="visualize" default="false" />  <!-- Whether to display RVIZ visualizations -->
  <arg name="use_filtered_clusters" default="true" />  <!-- Use filtered clusters from classification instead of internal clustering -->
  <arg name="filtered_topic_prefix" default="/filt_cluster_" />  <!-- Prefix for filtered cluster topics -->
  
  <!-- Max Batch Size -->
  <arg name="max_cluster_topics" default="32"/>
  <!-- Offline Cluster Extractor for Data Collection -->
  <arg name="run_cluster_extractor" default="false"/>
  <arg name="cluster_output_dir" default="/output_dir"/>
  <arg name="cluster_file_prefix" default="location"/>
  <arg name="save_clusters_as_bin" default="false"/>
  
  <!-- Model architecture config -->
  <arg name="cfg_path" default="$(find pointosr)/pointnext/cfgs/pointnext-s.yaml"/>
  <!-- Model checkpoint -->
  <arg name="model_path" default="/home/cerlab/Documents/data/pointosr/ckpt/cfgs-train-pointnext-s-ngpus1-seed42-20250824-130842-fzwiyYEtV7a4GyHM2H48rq_ckpt_best.pth" />
  <!-- Dataset and calibration directories -->
  <arg name="data_dir" default="/home/cerlab/Documents/data/pointosr/dataset"/>
  <arg name="calibration_cache_dir" default="src/pointosr/calib_cache" /> <!-- keep default -->
  <!-- Conda environment -->
  <arg name="launch_prefix" default="" />
  <!-- Calibration parameters -->
  <arg name="k_human" default="6" />
  <arg name="k_false" default="4" />
  <arg name="target_tpr" default="0.99" />

  <!-- ========== Run Nodes ========== -->
  <!-- Auto-generated arguments -->
  <arg name="use_drift" value="$(eval arg('drift_simulation_rollout')!='')" />

  <!-- Play the data -->
  <include file="$(find dynablox_ros)/launch/play_doals_data.launch" pass_all_args="true" if="$(arg use_doals)"/>   
  <include file="$(find dynablox_ros)/launch/play_dynablox_data.launch" pass_all_args="true" unless="$(arg use_doals)"/> 
   
  <!-- Drift Simulation -->
  <node name="drift_reader" pkg="drift_simulation" type="drift_reader" output="screen" args="--alsologtostderr" if="$(arg use_drift)">
    <param name="drift_data_file_name" value="$(find drift_simulation)/config/rollouts/$(arg drift_simulation_rollout)" />
  </node>

  <!-- Motion Detection -->
  <node name="motion_detector" pkg="dynablox_ros" type="motion_detector" output="screen" args="--alsologtostderr" required="true">
    <remap from="pointcloud" to="/ouster/points" />
    <remap from="pointcloud" to="/pointcloud_drifted" if="$(arg use_drift)" />

    <!-- config -->
    <rosparam command="load" file="$(find dynablox_ros)/config/$(arg config_file)" />
    <param name="max_cluster_topics" value="$(arg max_cluster_topics)"/>

    <!-- filtered cluster mode -->
    <param name="use_filtered_clusters" value="$(arg use_filtered_clusters)" />
    <param name="filtered_topic_prefix" value="$(arg filtered_topic_prefix)" />
    <param name="filtered_trigger_topic" value="/motion_detector/cluster_batch" />
    
    <!-- batch classification mode -->
    <param name="use_batch_classification" value="true" />
    <param name="batch_classification_topic" value="/classified_clusters" />

    <!-- evaluation -->
    <param name="evaluation/ground_truth/file_path" value="$(arg ground_truth_file)" />
    <param name="evaluation/output_directory" value="$(arg eval_output_path)" />
    <param name="evaluate" value="$(arg evaluate)" />    

  </node>
  
  <!-- Use Cluster Extractor if set to True -->
  <node pkg="dynablox_ros" type="cluster_extractor" name="cluster_extractor" output="screen" if="$(arg run_cluster_extractor)">
    <param name="output_dir" value="$(arg cluster_output_dir)"/>
    <param name="file_prefix" value="$(arg cluster_file_prefix)"/>
    <param name="save_as_bin" value="$(arg save_clusters_as_bin)"/>
    <param name="num_clusters" value="$(arg max_cluster_topics)"/>
  </node>
  
  <!-- Classification with Online Calibration -->
  <include file="$(find pointosr_ros)/launch/classification.launch" if="$(arg use_filtered_clusters)">
    <arg name="max_cluster_topics" value="$(arg max_cluster_topics)"/>
    <arg name="model_path" value="$(arg model_path)"/>
    <arg name="cfg_path" value="$(arg cfg_path)"/>
    <arg name="data_dir" value="$(arg data_dir)"/>
    <arg name="calibration_cache_dir" value="$(arg calibration_cache_dir)"/>
    <arg name="launch_prefix" value="$(arg launch_prefix)"/>
    <arg name="k_human" value="$(arg k_human)"/>
    <arg name="k_false" value="$(arg k_false)"/>
    <arg name="target_tpr" value="$(arg target_tpr)"/>
  </include>

  <!-- Visualize -->
  <include file="$(find dynablox_ros)/launch/visualizer.launch" if="$(arg visualize)"/> 

</launch>
